#! /bin/sh
#
# cron script to display all upgradeable packages using apt-listchanges
# (designed to replace the APT::Periodic::Unattended-Upgrade mechanism)
#
# Written by Jonathan Quick <jon@hartrao.ac.za>.

export PATH=$PATH:/sbin:/usr/sbin:/usr/local/sbin

PACKAGES=$(for file in `unattended-upgrade -v --dry-run 2>&1 | grep "^Packages that will be upgraded: " | cut -c33-`; do echo -n "/var/cache/apt/archives/$file*.deb "; done)

if [ -n "$PACKAGES" ]; then
	echo "Suggested Debian (Security?) Updates are:"
	echo
	apt-listchanges $PACKAGES
	echo "To install these upgrades run (as root)"
	echo
	echo "        apt -uy upgrade"
	echo "        apt clean"
	if echo $PACKAGES | grep -q "linux-image-"; then
		echo
		echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
		echo "NB: The Linux kernel image is one of the packages due to be upgraded."
		echo "NB: This will require a REBOOT and possibly out-of-tree modules to be rebuilt."
		echo "NB: Please allow _extra time_ for testing after the upgrade."
		echo "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!"
	fi
fi
